!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("taucharts"),require("d3-format"));else if("function"==typeof define&&define.amd)define([,"d3-format"],t);else{var r="object"==typeof exports?t(require("taucharts"),require("d3-format")):t(e.Taucharts,e.d3);for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(window,function(e,t){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=20)}({0:function(t,r){t.exports=e},20:function(e,t,r){"use strict";r.r(t);var n,a,i=r(0),o=r.n(i),c=r(8),l=o.a.api.utils,s=o.a.api.pluginsSDK,u=".tau-chart__legend__reset",d=".tau-chart__legend__item-color",h=".tau-chart__legend__guide--color__overlay",_=4,f=13,g=0,m=function(){return++g},p=o.a.api.utils.xml,v=function(e,t){var r=e[0],n=e[1],a=(n-r)/(t-1),i=l.range(t-2).map(function(e){return r+a*(e+1)});return[r].concat(i).concat(n)},b=function(e,t,r){if(e.length<3)return e.slice(0);if(t<3)return[e[0],e[e.length-1]];var n,a=e[0]<0?Math.abs(e[0]):0,i=function(e){return e},o="sqrt"===r?function(e){return Math.sqrt(e+a)}:i,c="sqrt"===r?function(e){return Math.pow(e,2)-a}:i,s=[(e=e.map(o))[0]],u=e[e.length-1]-e[0],d=.5*u/(t-1),h=l.range(1,t-1).map(function(e){var r=u*e/(t-1);return{min:r-d,mid:r,max:r+d,diff:Number.MAX_VALUE,closest:null}}),_=0,f=function(){if(_!==h.length){var e=n;(n=h[_++]).min=Math.max(n.min,(e&&null!==e.closest?e.closest:s[0])+d)}};return f(),e.forEach(function(e){if(!(e<n.min)){e>n.max&&f();var t=Math.abs(e-n.mid);t<n.diff&&t<d?(n.diff=t,n.closest=e):f(),0===t&&f()}}),h.forEach(function(e){null!==e.closest&&s.push(e.closest)}),s.push(e[e.length-1]),s=s.map(c)},y=function(e){return Math.log(e)/Math.LN10},x=function(e){return 0===e?0:Math.floor(y(Math.abs(e)))},w=(n=/\.0+([^\d].*)?$/,a=/(\.\d+?)0+([^\d].*)?$/,function(e){return e.replace(n,"$1").replace(a,"$1$2")}),S=c.format(".3s"),M=function(e){return w(S(e))},T=function(e,t){var r=Math.max(Math.abs(e),Math.abs(t)),n=x(r),a=e*t>0?Math.abs(t-e):r,i=x(a),o=Math.abs(n-i);return Math.abs(n)>3&&o<=3?M:function(e){var t=x(r-e),n=Math.min((i<0?Math.abs(i):0)+(t<i?1:0),20);return w(e.toFixed(n))}};function L(e){var t=l.defaults(e||{},{formatters:{}}),r=function(e){return null===e||""===e||void 0===e},n=function(e){return e.every(function(e){return l.isDate(e)})},a=function(e,t){return function(n){var a=n[e],i=JSON.stringify(r(a)?null:a);return t===i}},i=function(e,t,r,n){e.addEventListener(t,function(e){for(var t=e.target;t!==e.currentTarget&&null!==t;)t.matches(r)&&n(e,t),t=t.parentNode})};return{init:function(e){this.instanceId=m(),this._chart=e,this._currentFilters={},this._legendColorByScaleId={},this._legendOrderState={};var r=this._chart.getSpec(),n=function(e){return function(t,n){var a=r.scales[n];return a.type===e&&a.dim&&t.push(n),t}};this._color=Object.keys(r.scales).reduce(n("color"),[]).filter(function(t){return e.getScaleInfo(t).discrete}),this._fill=Object.keys(r.scales).reduce(n("color"),[]).filter(function(t){return!e.getScaleInfo(t).discrete}),this._size=Object.keys(r.scales).reduce(n("size"),[]);var a=this._color.length>0,o=this._fill.length>0,c=this._size.length>0;if(this._assignStaticBrewersOrEx(),a||o||c){switch(t.position){case"left":this._container=this._chart.insertToLeftSidebar(this._containerTemplate);break;case"right":this._container=this._chart.insertToRightSidebar(this._containerTemplate);break;case"top":this._container=this._chart.insertToHeader(this._containerTemplate);break;case"bottom":this._container=this._chart.insertToFooter(this._containerTemplate);break;default:this._container=this._chart.insertToRightSidebar(this._containerTemplate)}a&&(i(this._container,"click",u,function(e,t){this._toggleLegendItem(t,"reset")}.bind(this)),i(this._container,"click",d,function(e,t){var r=e.ctrlKey||e.target.matches(h)?"leave-others":"focus-single";this._toggleLegendItem(t,r)}.bind(this)),i(this._container,"mouseover",d,function(e,t){this._highlightToggle(t,!0)}.bind(this)),i(this._container,"mouseout",d,function(e,t){this._highlightToggle(t,!1)}.bind(this)))}},destroy:function(){var e=this._currentFilters,t=this._chart;Object.keys(e).forEach(function(r){return t.removeFilter(e[r])}),this._container&&this._container.parentElement&&(this._clearPanel(),this._container.parentElement.removeChild(this._container))},onSpecReady:function(e,r){this._formatters=s.getFieldFormatters(r,t.formatters)},_getFormat:function(e){return this._formatters[e]?this._formatters[e].format:function(e){return String(e)}},onRender:function(){this._clearPanel(),this._drawColorLegend(),this._drawFillLegend(),this._drawSizeLegend()},_containerTemplate:'<div class="tau-chart__legend"></div>',_template:l.template(['<div class="tau-chart__legend__wrap">',"<%=top%>",'<div class="tau-chart__legend__title"><%=name%></div>',"<%=items%>","</div>"].join("")),_itemTemplate:l.template(["<div data-scale-id='<%= scaleId %>' data-dim='<%= dim %>' data-value='<%= value %>' class=\"tau-chart__legend__item tau-chart__legend__item-color <%=classDisabled%>\">",'   <div class="tau-chart__legend__guide__wrap">','   <div class="tau-chart__legend__guide tau-chart__legend__guide--color <%=cssClass%>"','        style="background-color: <%=cssColor%>; border-color: <%=borderColor%>;">','       <div class="tau-chart__legend__guide--color__overlay">',"       </div>","   </div>","   </div>",'   <span class="tau-chart__legend__guide__label"><%=label%></span>',"</div>"].join("")),_resetTemplate:l.template(['<div class="tau-chart__legend__reset <%=classDisabled%>">','    <div role="button" class="tau-chart__button">Reset</div>',"</div>"].join("")),_clearPanel:function(){this._container&&(clearTimeout(this._scrollTimeout),this._getScrollContainer().removeEventListener("scroll",this._scrollListener),this._container.innerHTML="")},_drawFillLegend:function(){var e=this;e._fill.forEach(function(t){var r,a,i,o=e._chart.select(function(e){return e.config.color===t})[0];if(o){var c=o.config.guide||{},u=o.getScale("color"),d=u.domain().sort(function(e,t){return e-t}),h=n(d),_=h?d.map(Number):d,g=T(_[0],_[_.length-1]),m=function(){var t=e._chart.getSpec(),r=s.extractFieldsFormatInfo(t)[u.dim].format;return r||(r=function(e){return new Date(e)}),function(e){return String(r(e))}}(),b=h?m:g,y=u.brewer.length,x=((c.color||{}).label||{}).text||u.dim,w=function(e){return e.length*f*.618},S=u.isInteger?(_[1]-_[0])%3==0?4:(_[1]-_[0])%2==0?3:2:3,M=v(_,S),L=(h?M.map(function(e){return new Date(e)}):M).map(b);L[0]===L[L.length-1]&&(L=[L[0]]),e._container.insertAdjacentHTML("beforeend",e._template({name:x,top:null,items:'<div class="tau-chart__legend__gradient-wrapper"></div>'}));var C=e._container.lastElementChild.querySelector(".tau-chart__legend__gradient-wrapper"),A=C.getBoundingClientRect().width,F=!1;L.reduce(function(e,t){return e+w(t)},0)>A&&(L.length>1&&w(L[0])+w(L[L.length-1])>A?F=!0:L=[L[0],L[L.length-1]]);var E=F?(i=-.382*f/2,{width:A,height:120,barX:0,barY:0,barWidth:20,barHeight:120,textAnchor:"start",textX:l.range(S).map(function(){return 25}),textY:1===L.length?60+.618*f:L.map(function(e,t){var r=(L.length-1-t)/(L.length-1);return f*(1-r)+120*r+i})}):(r=w(L[0])/2,a=w(L[L.length-1])/2,{width:A,height:28+f,barX:0,barY:0,barWidth:A,barHeight:20,textAnchor:"middle",textX:1===L.length?[A/2]:L.map(function(e,t){var n=t/(L.length-1);return r*(1-n)+(A-a)*n}),textY:l.range(S).map(function(){return 28+f})}),j=v(_,y).map(function(e,t){return p("stop",{offset:t/(y-1)*100+"%",style:"stop-color:"+u(e)+';stop-opacity:1"'})}),k="legend-gradient-"+e.instanceId,I=p.apply(void 0,["svg",{class:"tau-chart__legend__gradient",width:E.width,height:E.height},p("defs",p.apply(void 0,["linearGradient",{id:k,x1:"0%",y1:F?"100%":"0%",x2:F?"0%":"100%",y2:"0%"}].concat(j))),p("rect",{class:"tau-chart__legend__gradient__bar",x:E.barX,y:E.barY,width:E.barWidth,height:E.barHeight,fill:"url(#"+k+")"})].concat(L.map(function(e,t){return p("text",{x:E.textX[t],y:E.textY[t],"text-anchor":E.textAnchor},e)})));C.insertAdjacentHTML("beforeend",I)}})},_drawSizeLegend:function(){var e=this;e._size.forEach(function(t){var r=e._chart.select(function(e){return e.config.size===t})[0];if(r){var n=r.config.guide||{},a=r.getScale("size"),i=a.domain().sort(function(e,t){return e-t});if(!Array.isArray(i)||!i.every(isFinite))return;var o=((n.size||{}).label||{}).text||a.dim,c=i[0],s=i[i.length-1],u=[c];if(s-c){var d=y(s-c),h=Math.round(4-d),g=Math.pow(10,h),m=l.unique(e._chart.getDataSources({excludeFilter:["legend"]})[a.source].data.map(function(e){return e[a.dim]}).filter(function(e){return e>=c&&e<=s})).sort(function(e,t){return e-t}),v=b(m,_,a.funcType);u=l.unique(v.map(function(e){return Math.round(e*g)/g}))}var x=T(u[0],u[u.length-1]),w=function(e){return e.length*f*.618};u.reverse();var S=u.map(a),M=Math.max.apply(null,S),L=u.map(x);e._container.insertAdjacentHTML("beforeend",e._template({name:o,top:null,items:'<div class="tau-chart__legend__size-wrapper"></div>'}));var C=e._container.lastElementChild.querySelector(".tau-chart__legend__size-wrapper"),A=C.getBoundingClientRect().width,F=!1;(Math.max.apply(null,L.map(w))>A/4||1===L.length)&&(F=!0);var E=F?function(){for(var e,t,r=f,n=S[0]/2,a=S[S.length-1]/2,i=[n],o=1;o<S.length;o++)t=S[o-1]/2,e=S[o]/2,i.push(i[o-1]+Math.max(1.618*f,t+r+e));var c=.618*f/2;return{width:A,height:i[i.length-1]+Math.max(a,f/2),circleX:l.range(S.length).map(function(){return M/2}),circleY:i,textAnchor:"start",textX:l.range(L.length).map(function(){return M+8}),textY:i.map(function(e){return e+c})}}():function(){for(var e,t,r=Math.max(w(L[0])/2,S[0]/2),n=Math.max(w(L[L.length-1])/2,S[S.length-1]/2),a=(A-S.reduce(function(e,t,r){return e+(0===r||r===S.length-1?t/2:t)},0)-r-n)/(_-1),i=[r],o=1;o<S.length;o++)t=S[o-1]/2,e=S[o]/2,i.push(i[o-1]+t+a+e);var c=S.map(function(e){return M-e/2});return{width:A,height:M+8+f,circleX:i,circleY:c,textAnchor:"middle",textX:i,textY:l.range(L.length).map(function(){return M+8+f})}}(),j=p.apply(void 0,["svg",{class:"tau-chart__legend__size",width:E.width,height:E.height}].concat(S.map(function(e,t){return p("circle",{class:"tau-chart__legend__size__item__circle "+(r.config.color?"color-definite":"color-default-size"),cx:E.circleX[t],cy:E.circleY[t],r:e/2})}),L.map(function(e,t){return p("text",{class:"tau-chart__legend__size__item__label",x:E.textX[t],y:E.textY[t],"text-anchor":E.textAnchor},e)})));C.insertAdjacentHTML("beforeend",j)}})},_drawColorLegend:function(){var e=this;e._color.forEach(function(t){var a=e._chart.select(function(e){return e.config.color===t})[0];if(a){var i=a.config.guide||{},o=a.getScale("color"),c=e._chart.getDataSources({excludeFilter:["legend"]}),s=l.unique(c[o.source].data.map(function(e){return e[o.dim]})),u=e._chart.getSpec().scales[t],d=n(s);if(u.order)s=l.union(l.intersection(u.order,s),s);else if("order"===u.dimType&&d)s=s.sort(function(e,t){return new Date(e)-new Date(t)});else{var h=e._legendOrderState[t];s=s.sort(function(e,t){var r=h[e]-h[t];return r&&r/Math.abs(r)})}var _=((i.color||{}).label||{}).text||o.dim,f=(i.color||{}).tickFormatNullAlias||"No "+_,g=e._getFormat(o.dim),m=s.map(function(n){var a=JSON.stringify(r(n)?null:n),i=o.dim+a;return{scaleId:t,dim:o.dim,color:o(n),disabled:e._currentFilters.hasOwnProperty(i),label:g(n),value:a}});e._legendColorByScaleId[t]=m,e._container.insertAdjacentHTML("beforeend",e._template({name:_,top:e._resetTemplate({classDisabled:m.some(function(e){return e.disabled})?"":"disabled"}),items:m.map(function(t){return e._itemTemplate({scaleId:t.scaleId,dim:l.escape(t.dim),color:t.color,cssClass:o.toClass(t.color),cssColor:t.disabled?"transparent":o.toColor(t.color),borderColor:o.toColor(t.color),classDisabled:t.disabled?"disabled":"",label:l.escape(r(t.label)?f:t.label),value:l.escape(t.value)})}).join("")}))}}),e._color.length>0&&(e._updateResetButtonPosition(),e._scrollTimeout=null,e._scrollListener=function(){var t=e._container.querySelector(u);t.style.display="none",e._scrollTimeout&&clearTimeout(e._scrollTimeout),e._scrollTimeout=setTimeout(function(){e._updateResetButtonPosition(),t.style.display="",e._scrollTimeout=null},250)},e._getScrollContainer().addEventListener("scroll",e._scrollListener))},_toggleLegendItem:function(e,t){var r=this._currentFilters,n=e?Array.prototype.filter.call(e.parentNode.childNodes,function(e){return e.matches(d)}):null,i=function(e){var t=e.getAttribute("data-dim"),r=e.getAttribute("data-value");return{sid:e.getAttribute("data-scale-id"),dim:t,val:r,key:t+r}},o=function(e){return e in r},c=function(e,t){var n=i(e);if(o(n.key)===t)if(t){var c=r[n.key];delete r[n.key],e.classList.remove("disabled"),this._chart.removeFilter(c)}else{e.classList.add("disabled");var l=a(n.dim,n.val);r[n.key]=this._chart.addFilter({tag:"legend",predicate:function(e){return!l(e)}})}}.bind(this),l=function(t){return t===e},s=!!e&&o(i(e).key),u=function(e,t){e.querySelector(".tau-chart__legend__guide").style.backgroundColor=t?"":"transparent"};if("reset"===t)n.forEach(function(e){c(e,!0),u(e,!0)});else if("leave-others"===t)n.forEach(function(e){l(e)&&c(e,s)}),u(e,s);else if("focus-single"===t){var h=!s&&n.every(function(e){return l(e)||o(i(e).key)});n.forEach(function(e){var t=l(e)||h;c(e,t)}),s&&u(e,!0)}this._chart.refresh()},_highlightToggle:function(e,t){if(!e.matches(".disabled")){var r=e.getAttribute("data-dim"),n=e.getAttribute("data-value"),i=t?a(r,n):function(e){return null};this._chart.select(function(e){return!0}).forEach(function(e){e.fire("highlight",i)})}},_getScrollContainer:function(){return this._container.parentNode.parentNode},_updateResetButtonPosition:function(){this._container.querySelector(u).style.top=this._getScrollContainer().scrollTop+"px"},_generateColorMap:function(e,t){var r=t.length;return e.reduce(function(e,n,a){return e[n]=t[a%r],e},{})},_assignStaticBrewersOrEx:function(){var e=this;e._color.forEach(function(t){var r=e._chart.getSpec().scales[t],n=e._chart.getDataSources({excludeFilter:["legend"]}),a=e._chart.getScaleFactory(n).createScaleInfoByName(t).domain();if(!r.brewer||Array.isArray(r.brewer)){var i=r.brewer||l.range(20).map(function(e){return"color20-"+(1+e)});r.brewer=e._generateColorMap(a,i)}e._legendOrderState[t]=a.reduce(function(e,t,r){return e[t]=r,e},{})})}}}o.a.api.plugins.add("legend",L),t.default=L},8:function(e,r){e.exports=t}})});